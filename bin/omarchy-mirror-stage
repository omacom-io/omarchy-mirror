#!/bin/bash

# Default values
VERBOSE_RSYNC=""
VERBOSE_RCLONE=""

while [[ $# -gt 0 ]]; do
  case $1 in
  --upstream)
    UPSTREAM="$2"
    shift 2
    ;;
  --stage)
    STAGE="$2"
    shift 2
    ;;
  --verbose)
    VERBOSE_RSYNC="-v"
    VERBOSE_RCLONE="-vv"
    shift
    ;;
  *)
    echo "Unknown option: $1"
    echo "Usage: $0 [--upstream UPSTREAM] [--stage STAGE] [--verbose]"
    exit 1
    ;;
  esac
done

echo "Stage the entire mirror locally"
rsync -rlptH $VERBOSE_RSYNC --safe-links --delete-delay --delay-updates --copy-links rsync://$UPSTREAM $STAGE

# Mark freshness
echo "Mark freshness as $(date +%s)"
date +%s >"$STAGE/lastsync"

echo "Finished staging Omarchy mirror in ${SECONDS}s"
