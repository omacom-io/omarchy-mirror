#!/bin/bash

UPSTREAM="iad.mirror.rackspace.com/archlinux/"
STAGE="/mnt/arch-mirror/"
R2="omarchy:omarchy-mirror"

# Sync down the entire mirror
rsync -rlptHv --safe-links --delete-delay --delay-updates --copy-links rsync://$UPSTREAM $STAGE

# Mark freshness
date +%s > "$STAGE/lastsync"

# Upload mirror packages without meta data
rclone sync "$STAGE" "$R2" -P --fast-list \
  --transfers=8 --checkers=16 \
  --exclude '**/*.db*' --exclude '**/*.files*' --exclude '/lastsync' --exclude '/lastupdate' \
  --s3-metadata-directive REPLACE \
  --s3-cache-control "public,max-age=31536000,immutable"

# Upload db/files + lastsync/lastupdate last
rclone copy "$STAGE" "$R2" -P --fast-list \
  --transfers=4 \
  --include '**/*.db*' --include '**/*.files*' --include '/lastsync' --include '/lastupdate' \
  --s3-metadata-directive REPLACE \
  --s3-cache-control "no-cache"
